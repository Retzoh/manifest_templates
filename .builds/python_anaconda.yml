image: debian/buster
packages:
  - wget
sources:
  - https://git.sr.ht/~retzoh/manifest_templates
environment:
  repository_name: manifest_templates
  package_name: python-example
  package_path: python_anaconda
tasks:
  - install_conda: |
      wget -q http://repo.continuum.io/miniconda/\
      Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
      bash miniconda.sh -b -p $HOME/miniconda

      echo 'export PATH="$HOME/miniconda/bin:$PATH"' >> ~/.shell_setup
      echo '. /home/build/miniconda/etc/profile.d/conda.sh' >> ~/.shell_setup

  - setup_project_conda: |
      . ~/.shell_setup
      conda update --quiet --yes conda

      cd $repository_name/$package_path
      conda env create -q

  - setup_project_pip: |
      . ~/.shell_setup
      conda activate $package_name

      cd $repository_name/$package_path
      pip install .

  - integration_test: |
      . ~/.shell_setup
      conda activate $package_name

      cd $repository_name/$package_path
      pytest --cov=python_example tests/
